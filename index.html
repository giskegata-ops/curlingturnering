<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { 
  getFirestore, collection, getDocs, getDoc,
  addDoc, updateDoc, doc
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBqUL0dGsQKwLyVkayGfcI486fiAjdXcCA",
  authDomain: "curlingturnering.firebaseapp.com",
  projectId: "curlingturnering",
  storageBucket: "curlingturnering.firebasestorage.app",
  messagingSenderId: "841721815539",
  appId: "1:841721815539:web:e2734644cc50292a6af286"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* =============================
   REGISTRATION STATUS
============================= */

async function registrationOpen() {
  const snap = await getDoc(doc(db,"settings","tournament"));
  return snap.exists() && snap.data().registrationOpen === true;
}

/* =============================
   ADD TEAM (med duplikatsjekk)
============================= */

document.getElementById("addTeamBtn")
.addEventListener("click", async () => {

  if (!(await registrationOpen())) {
    alert("Påmelding er stengt!");
    return;
  }

  const name = document.getElementById("teamName").value.trim();
  if (!name) {
    alert("Skriv inn lagnavn");
    return;
  }

  const normalized = name.toLowerCase();
  const snap = await getDocs(collection(db,"teams"));

  let exists = false;
  snap.forEach(t=>{
    if(t.data().name.toLowerCase() === normalized){
      exists = true;
    }
  });

  if(exists){
    alert("Dette lagnavnet finnes allerede!");
    return;
  }

  await addDoc(collection(db,"teams"),{
    name,
    createdAt:new Date()
  });

  document.getElementById("teamName").value="";
  loadTeams();
});

/* =============================
   LOAD TEAMS
============================= */

async function loadTeams() {
  const snap = await getDocs(collection(db,"teams"));
  const ul = document.getElementById("teamList");
  ul.innerHTML="";
  snap.forEach(t=>{
    const li=document.createElement("li");
    li.textContent=t.data().name;
    ul.appendChild(li);
  });
}

/* =============================
   LOAD MATCHES + TABLE
============================= */

async function loadMatches() {

  const snap = await getDocs(collection(db,"matches"));
  const list = document.getElementById("matchList");
  list.innerHTML="";

  const standings = {};
  let matchNumber = 1;
  let next1="Ingen kamp";
  let next2="Ingen kamp";

  snap.forEach(m=>{

    const data=m.data();

    if(!standings[data.team1Name])
      standings[data.team1Name]={K:0,V:0,VET:0,TET:0,T:0,P:0};

    if(!standings[data.team2Name])
      standings[data.team2Name]={K:0,V:0,VET:0,TET:0,T:0,P:0};

    if(data.played){

      standings[data.team1Name].K++;
      standings[data.team2Name].K++;

      if(data.type==="ordinær"){
        if(data.score1>data.score2){
          standings[data.team1Name].V++;
          standings[data.team1Name].P+=3;
          standings[data.team2Name].T++;
        } else {
          standings[data.team2Name].V++;
          standings[data.team2Name].P+=3;
          standings[data.team1Name].T++;
        }
      }

      if(data.type==="et"){
        if(data.score1>data.score2){
          standings[data.team1Name].VET++;
          standings[data.team1Name].P+=2;
          standings[data.team2Name].TET++;
          standings[data.team2Name].P+=1;
        } else {
          standings[data.team2Name].VET++;
          standings[data.team2Name].P+=2;
          standings[data.team1Name].TET++;
          standings[data.team1Name].P+=1;
        }
      }
    }

    if(!data.played){
      if(data.bane===1 && next1==="Ingen kamp")
        next1=`${data.team1Name} vs ${data.team2Name}`;
      if(data.bane===2 && next2==="Ingen kamp")
        next2=`${data.team1Name} vs ${data.team2Name}`;
    }

    const div=document.createElement("div");

    div.innerHTML=`
      <strong>Kamp ${matchNumber}</strong> – Bane ${data.bane}: 
      ${data.team1Name}
      <input type="number" id="s1${matchNumber}" style="width:50px">
      -
      <input type="number" id="s2${matchNumber}" style="width:50px">
      ${data.team2Name}
      <select id="type${matchNumber}">
        <option value="ordinær">Ordinær</option>
        <option value="et">Ekstraomg.</option>
      </select>
      <button onclick="saveResult('${m.id}',${matchNumber})">
        Lagre
      </button>
    `;

    list.appendChild(div);
    matchNumber++;
  });

  document.getElementById("next1").textContent=next1;
  document.getElementById("next2").textContent=next2;

  const tableBody=document.getElementById("standings");
  tableBody.innerHTML="";

  const sorted=Object.entries(standings)
    .sort((a,b)=>b[1].P-a[1].P);

  sorted.forEach((team,i)=>{
    const row=document.createElement("tr");
    if(i<4) row.classList.add("top4");

    row.innerHTML=`
      <td>${i+1}</td>
      <td>${team[0]}</td>
      <td>${team[1].K}</td>
      <td>${team[1].V}</td>
      <td>${team[1].VET}</td>
      <td>${team[1].TET}</td>
      <td>${team[1].T}</td>
      <td>${team[1].P}</td>
    `;

    tableBody.appendChild(row);
  });
}

/* =============================
   SAVE RESULT
============================= */

window.saveResult = async function(id,nr){

  const s1=parseInt(document.getElementById("s1"+nr).value)||0;
  const s2=parseInt(document.getElementById("s2"+nr).value)||0;
  const type=document.getElementById("type"+nr).value;

  if(s1===s2){
    alert("Kan ikke ende likt");
    return;
  }

  await updateDoc(doc(db,"matches",id),{
    score1:s1,
    score2:s2,
    type,
    played:true
  });

  loadMatches();
};

/* =============================
   INIT
============================= */

loadTeams();
loadMatches();

</script>
